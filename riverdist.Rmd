---
title: riverdistを用いたネットワーク中の距離の算出
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    css: css/serifStyle.css
---

# このページを読むとできるようになること

- 河川のシェープファイル（ラインデータ）を使って、河川の2地点間以上の距離を計算することができるようになります。

## 目的とやること

`riverdist`パッケージを使うと、河川のラインデータをネットワークに変換し、ネットワーク上の点の間の距離を求めることができます。
このページでは`riverdist`パッケージを使った複数の点の間の距離を算出します。

```{r, message=0, warning=0}
library(tidyverse)
library(sf)
library(riverdist)
library(rnaturalearth)
```

```{r}
theme_set(theme_bw(base_size = 9))
```

## データの読み込み

データは事前に国土数値情報から北海道の河川（ライン）ダウンロードし、解凍した状態で同じディレクトリに置いておいてください (`W05-09_01_GML`)。
主に使うデータはラインデータ (`W05-09_01-g_Stream.shp`) となります。

```{r}
# データの読み込み
fname = "W05-09_01_GML/W05-09_01-g_Stream.shp"
river_line <- st_read(fname)
```

`sf`パッケージでは、shapefileの属性値が`data.frame`として認識されます。
なので、`tidyverse`との相性がよく、データの取扱いが比較的簡単です。
また、データも`ggplot(data) + geom_sf()`だけで描写できるのでコード量も短くて済みます。
データの中身を確認してみましょう。

```{r}
# データの確認
head(river_line)
```


属性値が日本語だと解析がやりにくいので、属性の名前を変更しましょう。


```{r}
# 日本語が列名だと不便なので、列名を変更する
names(river_line) <- c(
  "system_code", "river_code", "type", "rivername",
  "startID", "endID", "ref", "direction", "riv_st_ID", "riv_end_ID",
  "geometry"
  )

head(river_line)
```

## 使用する河川データの選択

今回は石狩川水系を対象として解析を進めます。
生データのままだと、解析や描写に時間がかかるので、使用する河川区間にデータを限定していきます。
特に`riverdist`では一つ一つのライン情報からネットワークを作成するので、できる限り無駄なラインは削除することをお勧めします。

```{r}
# 試しに全部のデータを描写してみる
ggplot(data = river_line) + geom_sf()
```

### 水系の選択

- 水系は水系コード`system_code`でフィルタリングできます
- 石狩川の水系コードは810103です
- 水系コードは国土数値情報の[水系域コード](https://nlftp.mlit.go.jp/ksj/gml/codelist/WaterSystemCodeCd.html)を適宜参照してください

```{r}
# 石狩川水系へのデータの抽出
ishikari <- river_line %>% filter(system_code == "810103")

# 描写
ggplot(data = ishikari) + geom_sf()
```

### 区間の選択

- 区間種別`type`を選択することで、さらにフィルタリングできます
- 今回は1級直轄区間("1")でフィルタリングします
- 区間種別についてはダウンロードページの区間種別 (W05_003) を参照してください

```{r}
# 区間種別でデータを抽出
ishikari_filtered <-  ishikari %>% mutate(type = as.numeric(type)) %>% 
  filter(type == 1)

# 描写
ggplot(ishikari_filtered) + geom_sf()
```

```{r}
head(ishikari)
```

## CRSの設定

読み込んだデータはそのままだとCRSが未設定になっています。
ここではCRSを追加します。

```{r, fig.cap = cap}
# crs未設定
ggplot(ishikari_filtered) + geom_sf()
cap = "crsが未設定だとx軸とy軸はただの値が表示される"
```

```{r, fig.cap = cap}
# crsを追加する
st_crs(ishikari_filtered) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

ggplot(ishikari_filtered) + geom_sf()

cap = "crsを設定すると緯度軽度表示になっていることがわかる"
```


## ポイントデータの追加

河川ネットワーク上で距離を算出したい点のデータをcsvファイルにまとめています。

```{r}
locationtable <- read_csv("pointdata.csv")
knitr::kable(locationtable)
```

```{r}
loc <- st_read("pointdata.csv",
  options = c("X_POSSIBLE_NAMES=lon","Y_POSSIBLE_NAMES=lat"), quiet = TRUE)
st_crs(loc) <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"
```

```{r}
ggplot(ishikari_filtered) + geom_sf() +
  geom_sf(data = loc, inherit.aes = FALSE, shape = 24, fill = "yellow", size = 4)
```


## ネットワークの作成

riverdistではネットワークを作るところから始まる。
ラインが細かすぎると処理が遅いのでデータの区間を限定したほうがよい。
今回は区間種別でフィルターを作成するが、QGISなどですでに処理済みのデータを作成しておいてもよい

### 作業

1. UTM座標系に変換
2. `spatial dataframe`にデータ形式を変更する
3. `line2network()`でネットワークを作成する

```{r}
# UTM座標系に変換
ishikari_utm <- st_transform(ishikari_filtered, "+init=epsg:32654")
ishikari_river_network <- line2network(as_Spatial(ishikari_utm))
plot(ishikari_river_network)
```

## 河川中でのポイントデータの位置を計算する

```{r}
# ポイントデータをutm座標系に変換する
points <- st_transform(loc, "+init=epsg:32654") %>% 
  mutate(
    x = st_coordinates(geometry)[, 1],
    y = st_coordinates(geometry)[, 2]
  )

# ポイントデータのriver networkの中での位置を算出する
locs_in_river <- xy2segvert(
  x = points$x, y = points$y,
  rivers = ishikari_river_network)
```

## 距離を算出する

```{r}
# 距離行列を算出する
distmat <- riverdistancemat(
  locs_in_river$seg, locs_in_river$vert, ishikari_river_network
)
```

```{r}

```


## 参考URL

### shape fileについて

- [国土数値情報ダウンロードサービス:河川](https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-W05.html)

### sf

- [RでGISをやるときにはsfパッケージ、という世の中になるらしい。](https://notchained.hatenablog.com/entry/2017/01/06/213333)
- [sfパッケージを用いてRでの空間データの取り扱いを学ぶ](https://tsukubar.github.io/r-spatial-guide/simple-feature-for-r.html):
  - sfからspへの変換
- [Load a CSV as Simple Features R](https://gis.stackexchange.com/questions/305403/load-a-csv-as-simple-features-r): csvファイルをsfで読み込む
- [Rを使った地理空間情報データの処理～その2～](https://qiita.com/iwasaki_kenichi/items/e2f0c6777263a93c7230): 座標系の設定と変換について
- [CRSの追加](https://keita43a.hatenablog.com/entry/2018/10/24/004341)